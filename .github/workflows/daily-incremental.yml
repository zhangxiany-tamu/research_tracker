name: Daily Incremental Paper Updates

on:
  schedule:
    # Run daily at 6 AM UTC - incremental updates only  
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual triggering
    inputs:
      days_back:
        description: 'Days back to consider "recent" (default: 60)'
        required: false
        default: '60'
        type: string

jobs:
  incremental-update:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Much faster than full scrape
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run incremental scraping (recent papers only)
      env:
        CLOUD_URL: ${{ secrets.CLOUD_URL || 'https://research-tracker-466018.uc.r.appspot.com' }}
        DAYS_BACK: ${{ github.event.inputs.days_back || '60' }}
      run: |
        echo "🔄 Starting incremental update (last $DAYS_BACK days)"
        python scripts/incremental_scrape_and_sync.py
        
    - name: Create incremental summary
      run: |
        echo '## 🔄 Daily Incremental Update Summary' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
        echo '**Efficiency Focus**: Only processing recent papers (last 60 days)' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
        echo '### Key Benefits:' >> $GITHUB_STEP_SUMMARY
        echo '- ⚡ **Faster**: ~2-5 minutes vs 20-30 minutes for full scrape' >> $GITHUB_STEP_SUMMARY
        echo '- 🎯 **Targeted**: Only processes papers likely to be new' >> $GITHUB_STEP_SUMMARY
        echo '- 🔒 **Safer**: Lower risk of rate limiting or blocking' >> $GITHUB_STEP_SUMMARY
        echo '- 💰 **Cheaper**: Uses less compute resources and bandwidth' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
        echo '### Database Status:' >> $GITHUB_STEP_SUMMARY
        echo '- 🗄️ **Persistent**: PostgreSQL database retains all papers' >> $GITHUB_STEP_SUMMARY
        echo '- 🔄 **Incremental**: Only new papers are added, no duplicates' >> $GITHUB_STEP_SUMMARY
        echo '- 📊 **Efficient**: Sync only processes truly new papers' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
        echo "🕐 Incremental update completed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        
    - name: Notify on failure
      if: failure()
      run: |
        echo '❌ Daily incremental update failed!' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY  
        echo '**Fallback**: Weekly full scrape will ensure data integrity' >> $GITHUB_STEP_SUMMARY